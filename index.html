<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estaciona+ ‚Ä¢ Controle de Placas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-sm border-b sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-bold">P</div>
          <h1 class="text-xl font-bold">Estaciona+</h1>
        </div>
        <button onclick="sincronizarTudo()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
          Sincronizar
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Status -->
    <div id="statusAlert" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl fade-in">
      <div class="flex items-center">
        <span class="text-yellow-600 mr-2">‚ö†Ô∏è</span>
        <span class="text-yellow-800 text-sm" id="statusText">Verificando conex√£o...</span>
        <button onclick="verificarConexao()" class="ml-auto bg-yellow-100 hover:bg-yellow-200 text-yellow-800 px-3 py-1 rounded-lg text-sm">
          Testar Conex√£o
        </button>
      </div>
    </div>

    <!-- Resumo -->
    <section class="mb-8">
      <h2 class="text-2xl font-bold mb-4">Resumo</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Carros Pagos</div>
          <div class="text-2xl font-bold text-green-600" id="carrosPagos">R$ 0,00</div>
          <div class="text-xs text-gray-500" id="carrosPagosInfo">0 de 0</div>
        </div>
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Motos Pagas</div>
          <div class="text-2xl font-bold text-purple-600" id="motosPagas">R$ 0,00</div>
          <div class="text-xs text-gray-500" id="motosPagasInfo">0 de 0</div>
        </div>
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Pend. Carros</div>
          <div class="text-2xl font-bold text-orange-600" id="pendCarros">R$ 0,00</div>
          <div class="text-xs text-gray-500" id="pendCarrosInfo">0 itens</div>
        </div>
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Pend. Motos</div>
          <div class="text-2xl font-bold text-orange-600" id="pendMotos">R$ 0,00</div>
          <div class="text-xs text-gray-500" id="pendMotosInfo">0 itens</div>
        </div>
      </div>
    </section>

    <!-- Formul√°rio -->
    <section class="mb-8">
      <h2 class="text-2xl font-bold mb-4">Adicionar Ve√≠culo</h2>
      <div class="bg-white rounded-xl border p-6">
        <form id="addForm" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
          <div class="md:col-span-3">
            <label class="block text-sm font-medium mb-1">Placa</label>
            <input type="text" id="placaInput" placeholder="ABC-1234" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Tipo</label>
            <select id="tipoSelect" class="w-full px-3 py-2 border rounded-lg">
              <option value="carro">Carro</option>
              <option value="moto">Moto</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Valor (R$)</label>
            <input type="number" id="valorInput" step="0.01" placeholder="0,00" class="w-full px-3 py-2 border rounded-lg">
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Pagamento</label>
            <select id="pagamentoSelect" class="w-full px-3 py-2 border rounded-lg">
              <option value="dinheiro">Dinheiro</option>
              <option value="pix">Pix</option>
            </select>
          </div>
          <div class="md:col-span-1 flex items-center">
            <input type="checkbox" id="pagoCheckbox" class="w-4 h-4">
            <label class="ml-2 text-sm">Pago</label>
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">
              Adicionar
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Lista -->
    <section>
      <div class="flex justify-between mb-4">
        <h2 class="text-2xl font-bold">Ve√≠culos</h2>
        <input type="text" id="searchInput" placeholder="Buscar placa..." class="px-3 py-2 border rounded-lg">
      </div>
      <div id="veiculosList" class="space-y-3">
        <div class="text-center py-8 text-gray-500">Nenhum ve√≠culo cadastrado</div>
      </div>
    </section>
  </main>

  <script>
    // CONFIGURA√á√ÉO
    const API_BASE_URL = 'estacionamento2.up.railway.app';
    let veiculos = [];
    let isOnline = false;
    let pendentesSincronizacao = [];

    // INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', function() {
      carregarDadosLocais();
      verificarConexao();
      configurarEventos();
      setInterval(verificarConexao, 30000); // Verifica a cada 30 segundos
    });

    // CONFIGURAR EVENTOS
    function configurarEventos() {
      document.getElementById('addForm').addEventListener('submit', adicionarVeiculo);
      document.getElementById('searchInput').addEventListener('input', renderizarVeiculos);
    }

    // üéØ FUN√á√ÉO PRINCIPAL: ADICIONAR VE√çCULO
    async function adicionarVeiculo(e) {
      e.preventDefault();
      
      const placa = document.getElementById('placaInput').value.trim().toUpperCase();
      const tipo = document.getElementById('tipoSelect').value;
      const valor = parseFloat(document.getElementById('valorInput').value) || 0;
      const formaPagamento = document.getElementById('pagamentoSelect').value;
      const pago = document.getElementById('pagoCheckbox').checked;

      if (!placa) {
        alert('Informe a placa!');
        return;
      }

      // Verificar duplicata local
      if (veiculos.some(v => v.placa === placa)) {
        alert('Placa j√° existe!');
        return;
      }

      const novoVeiculo = {
        id: Date.now().toString(),
        placa,
        tipo,
        valor,
        formaPagamento,
        pago,
        entrada: new Date().toISOString(),
        sincronizado: false // üÜï Marca como n√£o sincronizado
      };

      // 1. SEMPRE SALVA LOCALMENTE
      veiculos.unshift(novoVeiculo);
      salvarLocalmente();
      renderizarVeiculos();
      atualizarResumo();

      // 2. TENTA ENVIAR PARA O BACKEND SE ESTIVER ONLINE
      if (isOnline) {
        const sucesso = await enviarParaBackend(novoVeiculo);
        if (sucesso) {
          novoVeiculo.sincronizado = true;
          salvarLocalmente();
          mostrarMensagem('‚úÖ Ve√≠culo salvo e sincronizado!', 'success');
        }
      } else {
        // Se offline, marca para sincronizar depois
        pendentesSincronizacao.push(novoVeiculo.id);
        mostrarMensagem('üíæ Ve√≠culo salvo localmente (offline)', 'warning');
      }

      document.getElementById('addForm').reset();
    }

    // üöÄ ENVIAR VE√çCULO PARA BACKEND
    async function enviarParaBackend(veiculo) {
      try {
        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(veiculo)
        });

        if (response.ok) {
          console.log('‚úÖ Ve√≠culo sincronizado:', veiculo.placa);
          return true;
        }
      } catch (error) {
        console.log('‚ùå Erro ao sincronizar:', veiculo.placa);
      }
      return false;
    }

    // üîÑ SINCRONIZAR TUDO - Tenta enviar todos os pendentes
    async function sincronizarTudo() {
      if (!isOnline) {
        mostrarMensagem('üåê Conecte-se √† internet para sincronizar', 'warning');
        return;
      }

      const pendentes = veiculos.filter(v => !v.sincronizado);
      if (pendentes.length === 0) {
        mostrarMensagem('‚úÖ Todos os dados est√£o sincronizados!', 'success');
        return;
      }

      mostrarMensagem('üîÑ Sincronizando...', 'info');
      
      let sucessos = 0;
      for (const veiculo of pendentes) {
        const sucesso = await enviarParaBackend(veiculo);
        if (sucesso) {
          veiculo.sincronizado = true;
          sucessos++;
        }
      }

      salvarLocalmente();
      renderizarVeiculos();
      
      if (sucessos === pendentes.length) {
        mostrarMensagem(`‚úÖ ${sucessos} ve√≠culos sincronizados!`, 'success');
      } else {
        mostrarMensagem(`‚ö†Ô∏è ${sucessos}/${pendentes.length} ve√≠culos sincronizados`, 'warning');
      }
    }

    // üì° VERIFICAR CONEX√ÉO COM BACKEND
    async function verificarConexao() {
      try {
        const response = await fetch(API_BASE_URL, { method: 'GET' });
        isOnline = response.ok;
        
        if (isOnline) {
          document.getElementById('statusAlert').className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-xl fade-in';
          document.getElementById('statusText').textContent = '‚úÖ Conectado ao servidor';
          
          // üîÑ Tenta sincronizar automaticamente quando voltar online
          const pendentes = veiculos.filter(v => !v.sincronizado);
          if (pendentes.length > 0) {
            setTimeout(sincronizarTudo, 2000); // Sincroniza ap√≥s 2 segundos
          }
        } else {
          throw new Error('Offline');
        }
      } catch (error) {
        isOnline = false;
        document.getElementById('statusAlert').className = 'mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-xl fade-in';
        document.getElementById('statusText').textContent = '‚ö†Ô∏è Modo offline - dados salvos localmente';
      }
    }

    // üíæ FUN√á√ïES LOCAIS
    function carregarDadosLocais() {
      const dados = localStorage.getItem('estaciona_veiculos');
      veiculos = dados ? JSON.parse(dados) : [];
      renderizarVeiculos();
      atualizarResumo();
    }

    function salvarLocalmente() {
      localStorage.setItem('estaciona_veiculos', JSON.stringify(veiculos));
    }

    function renderizarVeiculos() {
      const container = document.getElementById('veiculosList');
      const busca = document.getElementById('searchInput').value.toLowerCase();
      
      const filtrados = veiculos.filter(v => v.placa.toLowerCase().includes(busca));
      
      if (filtrados.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum ve√≠culo encontrado</div>';
        return;
      }

      container.innerHTML = filtrados.map(veiculo => `
        <div class="bg-white rounded-xl border p-4 fade-in">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <div class="w-12 h-12 ${veiculo.tipo === 'carro' ? 'bg-green-100' : 'bg-purple-100'} rounded-lg flex items-center justify-center">
                ${veiculo.tipo === 'carro' ? 'üöó' : 'üèçÔ∏è'}
              </div>
              <div>
                <div class="font-bold">${veiculo.placa}</div>
                <div class="text-sm text-gray-500">
                  ${new Date(veiculo.entrada).toLocaleString('pt-BR')}
                  ‚Ä¢ ${veiculo.formaPagamento}
                  ${!veiculo.sincronizado ? '‚Ä¢ ‚ö†Ô∏è Pendente' : '‚Ä¢ ‚úÖ Sincronizado'}
                </div>
              </div>
            </div>
            
            <div class="text-right">
              <div class="${veiculo.pago ? 'text-green-600' : 'text-orange-600'} font-medium">
                ${veiculo.pago ? 'Pago' : 'Pendente'}
              </div>
              <div class="text-xl font-bold">R$ ${veiculo.valor.toFixed(2)}</div>
            </div>
            
            <div class="flex space-x-2">
              <button onclick="alternarPago('${veiculo.id}')" class="w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-lg">
                ${veiculo.pago ? '‚ùå' : '‚úÖ'}
              </button>
              <button onclick="removerVeiculo('${veiculo.id}')" class="w-10 h-10 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function alternarPago(id) {
      const veiculo = veiculos.find(v => v.id === id);
      if (veiculo) {
        veiculo.pago = !veiculo.pago;
        veiculo.sincronizado = false; // Marca como n√£o sincronizado
        salvarLocalmente();
        renderizarVeiculos();
        atualizarResumo();
        
        if (isOnline) {
          enviarParaBackend(veiculo).then(sucesso => {
            if (sucesso) {
              veiculo.sincronizado = true;
              salvarLocalmente();
              renderizarVeiculos();
            }
          });
        }
      }
    }

    function removerVeiculo(id) {
      if (confirm('Remover este ve√≠culo?')) {
        veiculos = veiculos.filter(v => v.id !== id);
        salvarLocalmente();
        renderizarVeiculos();
        atualizarResumo();
        mostrarMensagem('Ve√≠culo removido!', 'success');
      }
    }

    function atualizarResumo() {
      const carros = veiculos.filter(v => v.tipo === 'carro');
      const motos = veiculos.filter(v => v.tipo === 'moto');
      
      const carrosPagos = carros.filter(v => v.pago);
      const motosPagas = motos.filter(v => v.pago);
      
      document.getElementById('carrosPagos').textContent = `R$ ${carrosPagos.reduce((s, v) => s + v.valor, 0).toFixed(2)}`;
      document.getElementById('motosPagas').textContent = `R$ ${motosPagas.reduce((s, v) => s + v.valor, 0).toFixed(2)}`;
      document.getElementById('pendCarros').textContent = `R$ ${carros.filter(v => !v.pago).reduce((s, v) => s + v.valor, 0).toFixed(2)}`;
      document.getElementById('pendMotos').textContent = `R$ ${motos.filter(v => !v.pago).reduce((s, v) => s + v.valor, 0).toFixed(2)}`;
      
      document.getElementById('carrosPagosInfo').textContent = `${carrosPagos.length} de ${carros.length}`;
      document.getElementById('motosPagasInfo').textContent = `${motosPagas.length} de ${motos.length}`;
      document.getElementById('pendCarrosInfo').textContent = `${carros.filter(v => !v.pago).length} itens`;
      document.getElementById('pendMotosInfo').textContent = `${motos.filter(v => !v.pago).length} itens`;
    }

    function mostrarMensagem(texto, tipo) {
      // Implementa√ß√£o simples de mensagem
      alert(texto);
    }
  </script>
</body>
  </html>
